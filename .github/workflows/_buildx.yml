name: _buildx
on:
  workflow_call:
    inputs:
      pkg_type:
        default: static
        required: false
        type: string

env:
  _REPO_THIS: "_repo_this"
  _REPO_PKGS: "_repo_pkgs"
  _PUSH: false
  INST_DIR: "${{ github.workspace }}/${{ github.workflow }}"

jobs:
  _buildx:
    strategy:
      matrix:
        include:
          - platform: 'iphoneos'
            arch: 'arm64'
          - platform: 'iphonesimulator'
            arch: 'arm64'
          - platform: 'iphonesimulator'
            arch: 'x86_64'
          - platform: 'macosx'
            arch: 'arm64'
          - platform: 'macosx'
            arch: 'x86_64'
    runs-on: macos-14
    steps:
      - name: set env `_PUSH=true`
        if: ${{ github.event_name == 'push' }}
        run: echo "_PUSH=true" >> "$GITHUB_ENV"
      - name: checkout this repo
        uses: actions/checkout@v4
        with:
          path: ${{ env._REPO_THIS }}
      - name: checkout pre-compiled packages repo
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository_owner }}/packages
          path: ${{ env._REPO_PKGS }}
      - name: show debug info
        run: |
          env
          echo -e "\n"
          echo -e "${PWD}"
          echo -e "\n"
          ls -Alh -- ${_REPO_THIS}
          echo -e "\n"
          ls -Alh -- ${_REPO_PKGS}
      - name: set required env `_PKG_NAME`
        run: |
          echo "_PKG_NAME=${{ github.workflow }}" >> "$GITHUB_ENV"
      - name: set required env `_PKG_VERSION`
        run: |
          pushd -- "${{ env._REPO_THIS }}/deps/${{ env._PKG_NAME }}"
          echo "_PKG_VERSION=$(git describe --tags --always --abbrev=7)" >> "$GITHUB_ENV"
          popd
      - name: set required env `_PKG_ZIP_DIR`
        run: |
          echo "_PKG_ZIP_DIR=$(dirname ${{ env.INST_DIR }})" >> "$GITHUB_ENV"
      - name: set required env `_PKG_ZIP_NAME`
        run: |
          echo "_PKG_ZIP_NAME=${{ env._PKG_NAME }}_${{ matrix.platform }}_${{ matrix.arch }}_${{ env._PKG_VERSION }}_${{ inputs.pkg_type }}.zip" >> "$GITHUB_ENV"
      - name: buildx library - ${{ env._PKG_NAME }}
        run: |
          source ${{ env._REPO_THIS }}/build-${{ matrix.platform }}-${{ matrix.arch }}.sh
          compile ${{ env._PKG_NAME }} ${{ inputs.pkg_type }} ${{ matrix.platform }} ${{ matrix.arch }}

          pushd -- "${{ env._PKG_ZIP_DIR }}"
          zip -q -ry "${{ env._PKG_ZIP_NAME }}" "${{ env._PKG_NAME }}"
          popd
      - name: upload library - ${{ env._PKG_NAME }}
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env._PKG_ZIP_NAME }}
          path: ${{ env._PKG_ZIP_DIR }}/${{ env._PKG_ZIP_NAME }}
